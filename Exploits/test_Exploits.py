import unittest
import Exploits
from bs4 import BeautifulSoup


class MockObjectDetector(object):
 
    def page_html(self):
        pass

class TestExploits(unittest.TestCase):
    
    #setUp
    def setUp(self):
 
        self.total_exploits = Exploits.load_exploits()
 
    #test_load_exploits
    def test_load_exploits(self):

        self.assertGreater(len(self.total_exploits), 0)

class TestExploitSqliVersion(unittest.TestCase):

    def setUp(self):
 
        self.page_good = open('Exploits/test_data/good.html', 'r').read()
        self.page_bad = open('Exploits/test_data/bad.html', 'r').read()
        self.sqli_mysql_version_page = open('Exploits/test_data/sqli_mysql_version.html', 'r').read()
        self.sqli_mysql_run_user_page = open('Exploits/test_data/sqli_mysql_run_user.html', 'r').read()
        self.exploit = Exploits.ExploitSqliVersion()

    def test_check_if_exploit_found(self):

        # We should find a hit n this
        found = self.exploit.check_if_exploit_found(self.page_good)
        self.assertTrue(found)

        # We should find a miss n this
        found = self.exploit.check_if_exploit_found(self.page_bad)
        self.assertFalse(found)

    def test_extract_data_for_payload(self):

        #We should get forms data extracted list
        good = BeautifulSoup(self.page_good, 'html.parser')
        Forms = good.find_all('form')
        form_data = self.exploit.extract_data_for_payload(Forms)
        self.assertGreater(len(form_data), 0)

        #We should get empty forms data extracted list
        bad = BeautifulSoup(self.page_bad, 'html.parser')
        Forms = bad.find_all('form')
        form_data = self.exploit.extract_data_for_payload(Forms)
        self.assertEqual(len(form_data), 0)

    def test_did_attack_work(self):

        results = self.exploit.did_attack_work(self.sqli_mysql_version_page)
        self.assertNotEqual(results, False)

        results = self.exploit.did_attack_work(self.page_good)
        self.assertEqual(results, False)

        results = self.exploit.did_attack_work(self.page_bad)
        self.assertEqual(results, False)

class TestExploitSqliUser(unittest.TestCase):

    def setUp(self):
 
        self.page_good = open('Exploits/test_data/good.html', 'r').read()
        self.page_bad = open('Exploits/test_data/bad.html', 'r').read()
        self.sqli_mysql_run_user_page = open('Exploits/test_data/sqli_mysql_run_user.html', 'r').read()
        self.exploit = Exploits.ExploitSqliUser()

    def test_check_if_exploit_found(self):

        # We should find a hit n this
        found = self.exploit.check_if_exploit_found(self.page_good)
        self.assertTrue(found)

        # We should find a miss n this
        found = self.exploit.check_if_exploit_found(self.page_bad)
        self.assertFalse(found)

    def test_extract_data_for_payload(self):

        #We should get forms data extracted list
        good = BeautifulSoup(self.page_good, 'html.parser')
        Forms = good.find_all('form')
        form_data = self.exploit.extract_data_for_payload(Forms)
        self.assertGreater(len(form_data), 0)

        #We should get empty forms data extracted list
        bad = BeautifulSoup(self.page_bad, 'html.parser')
        Forms = bad.find_all('form')
        form_data = self.exploit.extract_data_for_payload(Forms)
        self.assertEqual(len(form_data), 0)

    def test_did_attack_work(self):

        results = self.exploit.did_attack_work(self.sqli_mysql_run_user_page)
        self.assertNotEqual(results, False)
        self.assertEqual(results['status'], True)

        results = self.exploit.did_attack_work(self.page_good)
        self.assertEqual(results, False)

        results = self.exploit.did_attack_work(self.page_bad)
        self.assertEqual(results, False)


if __name__ == '__main__':
    unittest.main()