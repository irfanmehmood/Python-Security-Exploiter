#!/usr/bin/env python


import sys
import os
import time


# SET PATH for our libs/classes
dir_path = os.path.dirname(os.path.realpath(__file__))
sys.path.append(dir_path + '/')
sys.path.append(dir_path + '/test')

# IMPORT OUR CUSTOM CLASSES/LIBS
##############################################################################################
from Db.db import Db
import config
from Utility.utility import Utility
#from Stats.stats import Stats


# INITIALISE OUR CLASSES/LIBS/GLOBALS
##############################################################################################

U = Utility()
Db = Db()
#stats = Stats()
JOB_URL = config.host['JOB_URL']
JOB_LOGIN_URL = config.host['JOB_LOGIN_URL']

#START OUR PROGRAM
##############################################################################################

U.cls()
U.show_splash_screen()
U.show_select_menu()


#Automate the whole process
def automate():
    #STEP 1. CREATE A JOB FOR THIS PASSED URL
    ##############################################################################################
    JOB = Db.job_get(JOB_URL)

    if (JOB):
        #Our job exists
        JOB_ID = str(JOB['_id'])
        U.cprint_show_job(JOB)
        U.cprint('RESTARTING JOB: '+ JOB_ID, 'OKGREEN', False, False)
        U.hr(False)
    else:    
        #Create new job and assign id
        U.hr(False)
        U.cprint('CREATING NEW [JOB]:  ' + JOB_URL, 'OKGREEN', False, False)
        U.hr(False)
        Db.job_create(JOB_URL, JOB_LOGIN_URL)
        JOB = Db.job_get(JOB_URL)
        JOB_ID = str(JOB['_id'])


    #STEP 2. FIND URLS TO CRAWL AND ADD TO DB QUEUE
    ###############################################################################################
    import Crawler.Crawler

    #STEP 3. FIND VULNERABILITIES IN QUEUED URLS
    ###############################################################################################
    import Analyser.Analyser

    #STEP 4. ATTACK VULNERABLE PAGES IN QUEUE
    ###############################################################################################
    import Attacker.Attacker
    

#Menu Choice
#####################################################################
choice = input("Enter a Choice: ")
if (choice == 1):
    automate()
elif (choice == 2):
    Db.jobs_clear_all_data()
else:
    U.cls()
    print 'bye'